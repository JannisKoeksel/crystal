%%{init: {'themeVariables': { 'fontSize': '12px'}}}%%
graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:1px,color:#000
    classDef itemplan fill:#fff,stroke-width:2px,color:#000
    classDef unbatchedplan fill:#dff,stroke-width:1px,color:#000
    classDef sideeffectplan fill:#fcc,stroke-width:2px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:2px,text-align:left

    subgraph "Buckets for subscriptions/v4/sub"
    Bucket0("Bucket 0 (root)<br /><br />1: <br />ᐳ: Access[7], Constantᐸ'x'ᐳ[30]<br />2: Lambda[8]<br />3: Listen[9]"):::bucket
    Bucket1("Bucket 1 (subscription)<br />Deps: 2, 4<br /><br />ROOT __Item{1}ᐸ9ᐳ[10]"):::bucket
    Bucket2("Bucket 2 (nullableBoundary)<br />Deps: 11, 2, 4<br /><br />ROOT JSONParse{1}ᐸ10ᐳ[11]<br />1: <br />ᐳ: Access[12]<br />2: Lambda[13]<br />ᐳ: Lambda[15], Lambda[16]"):::bucket
    Bucket3("Bucket 3 (polymorphic)<br />__typename: Lambda[16]<br />Deps: 16, 2, 15, 4"):::bucket
    Bucket4("Bucket 4 (polymorphicPartition)<br />|Query<br />Deps: 4<br />ᐳQuery"):::bucket
    Bucket5("Bucket 5 (polymorphicPartition)<br />|X<br />Deps: 2, 15<br />ᐳX<br /><br />1: Access[22], Access[23]<br />ᐳ: Access[29], Object[24]<br />2: PgSelect[21]<br />3: PgSelectRows[26]<br />ᐳ: 25, 27, 28"):::bucket
    end
    Bucket0 --> Bucket1
    Bucket1 --> Bucket2
    Bucket2 --> Bucket3
    Bucket3 --> Bucket4 & Bucket5

    %% plan dependencies
    Listen9[["Listen[9∈0@s] ➊"]]:::plan
    Access7{{"Access[7∈0] ➊<br />ᐸ2.pgSubscriberᐳ<br />More deps:<br />- __Value[2]"}}:::plan
    Lambda8[["Lambda[8∈0] ➊<br />More deps:<br />- Constantᐸ'x'ᐳ[30]"]]:::unbatchedplan
    Access7 & Lambda8 --> Listen9
    __Value2["__Value[2∈0] ➊<br />ᐸcontextᐳ<br />Dependents: 3"]:::plan
    __Item10[/"__Item[10∈1]<br />ᐸ9ᐳ"\]:::itemplan
    Listen9 ==> __Item10
    JSONParse11[["JSONParse[11∈1]<br />ᐸ10ᐳ"]]:::plan
    __Item10 --> JSONParse11
    Access12{{"Access[12∈2]<br />ᐸ11.__node__ᐳ"}}:::plan
    JSONParse11 --> Access12
    Lambda13[["Lambda[13∈2]<br />ᐸnodeObjToNodeIdᐳ"]]:::unbatchedplan
    Access12 --> Lambda13
    Lambda15{{"Lambda[15∈2]<br />ᐸdecodeNodeIdWithCodecsᐳ"}}:::plan
    Lambda13 --> Lambda15
    Lambda16{{"Lambda[16∈2]<br />ᐸfindTypeNameMatchᐳ"}}:::plan
    Lambda15 --> Lambda16
    PgSelect21[["PgSelect[21∈5]^<br />ᐸxᐳ"]]:::plan
    Object24{{"Object[24∈5] ➊^<br />ᐸ{pgSettings,withPgClient}ᐳ"}}:::plan
    Access29{{"Access[29∈5]<br />ᐸ15.base64JSON.1ᐳ<br />ᐳX"}}:::plan
    Access29 -->|rejectNull| PgSelect21
    Object24 --> PgSelect21
    Access22{{"Access[22∈5] ➊<br />ᐸ2.pgSettingsᐳ<br />ᐳX<br />More deps:<br />- __Value[2]"}}:::plan
    Access23{{"Access[23∈5] ➊<br />ᐸ2.withPgClientᐳ<br />ᐳX<br />More deps:<br />- __Value[2]"}}:::plan
    Access22 & Access23 --> Object24
    First25{{"First[25∈5]^"}}:::plan
    PgSelectRows26[["PgSelectRows[26∈5]^"]]:::plan
    PgSelectRows26 --> First25
    PgSelect21 --> PgSelectRows26
    PgSelectSingle27{{"PgSelectSingle[27∈5]^<br />ᐸxᐳ"}}:::plan
    First25 --> PgSelectSingle27
    PgClassExpression28{{"PgClassExpression[28∈5]^<br />ᐸ__x__.”name”ᐳ"}}:::plan
    PgSelectSingle27 --> PgClassExpression28
    Lambda15 --> Access29

    %% define steps
    classDef bucket0 stroke:#696969
    class Bucket0,__Value2,Access7,Lambda8,Listen9 bucket0
    classDef bucket1 stroke:#00bfff
    class Bucket1,__Item10,JSONParse11 bucket1
    classDef bucket2 stroke:#7f007f
    class Bucket2,Access12,Lambda13,Lambda15,Lambda16 bucket2
    classDef bucket3 stroke:#ffa500
    class Bucket3 bucket3
    classDef bucket4 stroke:#0000ff
    class Bucket4 bucket4
    classDef bucket5 stroke:#7fff00
    class Bucket5,PgSelect21,Access22,Access23,Object24,First25,PgSelectRows26,PgSelectSingle27,PgClassExpression28,Access29 bucket5

